<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="Vali is a responsive and free admin theme built with Bootstrap 4, SASS and PUG.js. It's fully customizable and modular.">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@pratikborsadiya">
    <meta property="twitter:creator" content="@pratikborsadiya">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Vali Admin">
    <meta property="og:title" content="Vali - Free Bootstrap 4 admin theme">
    <meta property="og:description" content="Vali is a responsive and free admin theme built with Bootstrap 4, SASS and PUG.js. It's fully customizable and modular.">
    <title>大屏页面信息</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- CSS-->


    <link href="../css/main.css" rel="stylesheet" />
    <!-- Font-icon css-->
    <link href="../css/font-awesome.min.css" rel="stylesheet" />
    <link href="../css/select2.css" rel="stylesheet" />
    <link href="../css/bootstrapValidator.min.css" rel="stylesheet" />

</head>
<body style="background-color:#E5E5E5;">

    <div class="col-md-12">
        <!--标题-->
        <div class="tile">
            <div class="col-md-12">
                <div class="row">
                    <h4><i class="fa fa-dashboard"></i> 大屏配置</h4>
                </div>
                <ul class="app-breadcrumb breadcrumb">
                    <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
                    <li class="breadcrumb-item"><a href="#"> </a></li>
                </ul>
            </div>
        </div>

        <!--菜单管理数据-->
        <div class="row" style="margin-top:20px;" id="DivTable" v-show="IsDisPlay">
            <div class="col-md-12">
                <div class="tile">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="btn-group" id="BtnGroup">
                                <button class="btn btn-primary btn-sm" type="button" v-on:click="btnClick" id="Add">添加</button>
                                <button class="btn btn-primary btn-sm" type="button" v-on:click="btnClick" id="Edit">修改</button>
                                <button class="btn btn-primary btn-sm" type="button" v-on:click="btnClick" id="Delete">删除</button>
                            </div>
                        </div>
                        <div class="row" style="margin-top:20px;">
                            <table class="table table-striped table-sm table-hover table-bordered">
                                <thead style="background-color:#6c757d;color:#E5E5E5">
                                    <tr>
                                        <td style="width:80px">选择</td>
                                        <th>大屏名称</th>
                                        <th>IP地址</th>
                                        <th>显示页面</th>
                                        <th>一屏显示页数</th>
                                        <th>备注</th>
                                    </tr>
                                </thead>
                                <tbody id="TableBody">
                                    <tr v-for="item in PageData">
                                        <td>
                                            <span class="animated-checkbox">
                                                <label style="margin:0;padding:0;">
                                                    <input type="checkbox" v-bind:value="item.id" v-model="IsChecked" />
                                                    <span class="label-text"></span>
                                                </label>
                                            </span>
                                        </td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.ip }}</td>
                                        <td>{{ item.pnames }}</td>
                                        <td>{{ item.shownum }}</td>
                                        <td>{{ item.remark }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!--添加修改表单-->
        <div class="row" style="margin-top:20px;display:none;" id="DivForm" v-show="IsDisPlay">
            <div class="col-md-12">
                <div class="tile">
                    <div class="col-md-12">
                        <div class="row">
                            <form class="col-md-12" id="Form" method="post">
                                <input type="hidden" id="Id" value="id" />


                                <div class="form-group">
                                    <label>大屏名称</label>
                                    <input class="form-control" type="text" placeholder="大屏名称" v-model="name" name="name" id="t_name">
                                </div>
                                <div class="form-group">
                                    <label>关联页面</label>
                                    <select id="f_select" placeholder="大屏名称" class="js-example-basic-multiple" multiple="multiple" style="width:100%"></select>
                                </div>
                                <div class="form-group">
                                    <label>IP地址</label>
                                    <input class="form-control" type="text" placeholder="大屏的IP地址" v-model="ip" name="ip" id="t_ip">
                                </div>
                                <div class="form-group">
                                    <label>同屏显示个数</label>
                                    <input class="form-control" type="text" placeholder="数字1,2,3,4" v-model="shownum" name="shownum" id="t_shownum">
                                </div>

                                <div class="form-group">
                                    <label>备注</label>
                                    <input class="form-control" type="text" placeholder="备注" v-model="remark" name="remark" id="t_remark">
                                </div>

                                <div class="form-group">
                                    <button class="btn btn-primary" type="button" v-on:click="Submit">确认</button>
                                    <button class="btn" type="button" id="Cancel" v-on:click="Cancel">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>



    <!--添加修改表单-->



    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/plugins/pace.min.js"></script>
    <script src="../js/select2.full.min.js"></script>
    <script src="../js/axios.min.js"></script>
    <script src="../js/bootstrapValidator.min.js"></script>

    <script src="../js/vue.min.js"></script>
    <script src="../js/vuex.js"></script>
    <script src="../js/vue-router.js"></script>
    <script src="../js/plugins/bootstrap-notify.min.js"></script>
    <script src="../js/Main.js"></script>
    <script type="text/javascript">

        var DivTable = new Vue({
            el: "#DivTable",
            data: {
                PageData: []
                , IsChecked: []
                , IsDisPlay: true

            },
            created: function () {
                this.LoadPage();
            },
            methods: {
                LoadPage: function () {
                    var _self = this;
                    $.ajax({
                        type: "POST",
                        cache: false,
                        url: '../../ashx/TVHandler.ashx',
                        data: { "action": "Query" },
                        dataType: "json",
                        success: function (data) {
                            _self.PageData = data.data;
                        },
                        error: function (XmlHttpRequest, textStatus, errorThrown) {
                            alert(XmlHttpRequest.responseText);
                        }
                    });
                },
                btnClick: function (event) {
                    if (event.currentTarget.id == "Add") this.Add();
                    else if (event.currentTarget.id == "Edit") this.Edit();
                    else if (event.currentTarget.id == "Delete") this.Delete();
                },
                Add: function () {
                    $('#f_select').val(null).trigger('change');// 清空
                    FormDiv.id = 0;
                    FormDiv.name = "";
                    FormDiv.remark = "";
                    FormDiv.ip = "";
                    FormDiv.shownum = 1;
                    FormDiv.IsDisPlay = true;
                    this.IsDisPlay = false;
                },
                Edit: function () {
                    if (this.IsChecked.length != 1) window.top.PromptMessage("提示", '请选择单条数据修改!', "info");
                    else {
                        var d = this.GetRowData();
                        FormDiv.id = d.id;
                        FormDiv.name = d.name;
                        FormDiv.remark = d.remark;
                        FormDiv.ip = d.ip;
                        FormDiv.shownum = d.shownum;
                        FormDiv.IsDisPlay = true;
                        var ids = d.pids.substring(0, d.pids.length - 1).split(',');
                        $('#f_select').val(ids).trigger('change');
                        this.IsDisPlay = false;
                    }
                },
                Delete: function () {
                    if (this.IsChecked.length != 1) window.top.PromptMessage("提示", '危险操作请单条删除!', "info");
                    else {
                        var params = {
                            "action": "Delete",
                            "id": this.IsChecked[0]
                        };
                        $.ajax({
                            type: "POST",
                            cache: false,
                            url: '../../ashx/TVHandler.ashx',
                            data: params,
                            dataType: "json",
                            success: function (data) {
                                if (data.type == 1) {
                                    window.location.href = "../../Web/html/TVConfig.html"
                                    window.top.PromptMessage("提示", data.msg, "success");
                                }
                                else window.top.PromptMessage("提示", data.msg, "info");

                            },
                            error: function (XmlHttpRequest, textStatus, errorThrown) {
                                alert(XmlHttpRequest.responseText);
                            }
                        });
                    }
                },
                GetRowData: function () {
                    var result;
                    id = this.IsChecked[0];
                    this.PageData.forEach(function (v, i) {
                        if (v.id == id) {
                            result = v;
                            return;
                        }
                    });
                    return result;
                }
            }
        });

        var FormDiv = new Vue({
            el: "#DivForm",
            data: {
                IsDisPlay: false,
                id: 0,
                name: "",
                remark: "",
                ip: "",
                shownum: 1

            },
            created: function () {
                this.LoadSelect();
            },
            methods: {
                LoadSelect: function () {
                    var _self = this;
                    $.ajax({
                        type: "POST",
                        cache: false,
                        url: '../../ashx/PageHandler.ashx',
                        data: { "action": "GetPageInfo" },
                        dataType: "json",
                        success: function (data) {
                            var arr = [];
                            data.data.forEach(function (v, i) {
                                arr[i] = { id: v.id, text: v.name };
                            });
                            $('.js-example-basic-multiple').select2({ data: arr });
                        },
                        error: function (XmlHttpRequest, textStatus, errorThrown) {
                            alert(XmlHttpRequest.responseText);
                        }
                    });
                },
                //提交
                Submit: function () {
                    $("#DivForm").bootstrapValidator('validate');//提交验证
                    if (!$("#DivForm").data('bootstrapValidator').isValid()) {//获取验证结果，如果成功，执行下面代码
                        return;
                    }
                    var params = {
                        "action": this.id == 0 ? "Add" : "Edit",
                        "ID": this.id,
                        "Name": this.name,
                        "IP": this.ip,
                        "Remark": this.remark,
                        "ShowNum": this.shownum,
                        "PageIds": $("#f_select").val().join()
                    }
                    $.ajax({
                        type: "POST",
                        cache: false,
                        url: '../../ashx/TVHandler.ashx',
                        data: params,
                        dataType: "json",
                        success: function (data) {
                            if (data.type == 1) {
                                window.location.href = "../../Web/html/TVConfig.html"
                                window.top.PromptMessage("提示", data.msg, "success");
                            }
                            else window.top.PromptMessage("提示", data.msg, "info");

                        },
                        error: function (XmlHttpRequest, textStatus, errorThrown) {
                            alert(XmlHttpRequest.responseText);
                        }
                    });
                },
                //取消
                Cancel: function () {
                    window.location.href = "../../Web/html/TVConfig.html"
                }
            }
        });

        ///加载验证控件
        function SetValidator() {
            $("#DivForm").bootstrapValidator({
                live: 'enabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                feedbackIcons: {//根据验证结果显示的各种图标
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    name: {
                        validators: {
                            notEmpty: {//检测非空,radio也可用
                                message: '大屏名称不能为空'
                            },
                            stringLength: {
                                min: 1,
                                max: 18,
                                message: '标题长度必须在1到18位之间'
                            },
                        }
                    },
                    ip: {
                        validators: {
                            notEmpty: {//检测非空,radio也可用
                                message: 'ip地址不能为空'
                            }
                        }
                    },
                    content: {
                        validators: {
                            notEmpty: {//检测非空,radio也可用
                                message: '个数不能为空'
                            }
                        }
                    },
                    sortindex: {
                        validators: {
                            regexp: {
                                regexp: /^[0-9]+$/,
                                message: '必须是数字'
                            }
                        }

                    },
                    shownum: {
                        validators: {
                            notEmpty: {//检测非空,radio也可用
                                message: '内容不能为空'
                            },
                            regexp: {
                                regexp: /^[1234]{1}$/,
                                message: '必须1,2,3,4数字'
                            }
                        }
                    }


                }
            });
        }
        $(function () {
            SetValidator();

            $("select").on("select2:select", function (evt) {
                var element = evt.params.data.element;
                var $element = $(element);

                $element.detach();
                $(this).append($element);
                $(this).trigger("change");
            });
        })

        /*


            $("#f_select").off().on("select2:select", function (evt) {
                var element = evt.params.data.element;
                var $element = $(element);
                $element.detach();
                var slectedL = $("#f_select").find("option:selected").length;
                if (slectedL < 1) {
                    $("#f_select").prepend($element);
                } else {
                    $("#f_select").find("option:eq(" + (slectedL - 1) + ")").after($element);
                }
                $("#f_select").trigger("change");
            }).on("select2:unselect", function (evt) {
                var element = evt.params.data.element;
                var $element = $(element);
                $element.detach();
                $("#f_select").append($element);
            });
        */




    </script>
</body>
</html>
